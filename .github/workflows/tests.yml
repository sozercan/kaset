name: Test Suite

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - "**.swift"
      - "Package.swift"
      - "Sources/**"
      - "Tests/**"
      - ".github/workflows/tests.yml"
  pull_request:
    branches: [main]
    paths:
      - "**.swift"
      - "Package.swift"
      - "Sources/**"
      - "Tests/**"
      - ".github/workflows/tests.yml"
  workflow_dispatch:

jobs:
  macos_unit_tests:
    name: macOS Unit Tests
    timeout-minutes: 20
    runs-on: macos-26
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Show Swift version
        run: swift --version

      - name: Clear SPM artifacts cache
        run: rm -rf ~/Library/Caches/org.swift.swiftpm/artifacts

      - name: Run unit tests
        run: swift test -q --skip KasetUITests

  macos_ui_tests:
    name: macOS UI Tests
    timeout-minutes: 30
    runs-on: macos-26
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Clear SPM artifacts cache
        run: rm -rf ~/Library/Caches/org.swift.swiftpm/artifacts

      - name: Build app bundle for UI tests
        env:
          KASET_SIGNING: adhoc
        run: Scripts/build-app.sh debug

      - name: Install app for UI tests
        run: |
          sudo cp -R .build/app/Kaset.app /Applications/Kaset.app
          # Register with Launch Services so XCUIApplication can find it
          /System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/LaunchServices.framework/Versions/A/Support/lsregister -f /Applications/Kaset.app

      - name: Run UI tests
        run: |
          set -o pipefail
          xcodebuild \
            -project KasetUITests.xcodeproj \
            -scheme KasetUITests \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            test

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: macOS-UITestResults
          path: ./build/*.xcresult
          retention-days: 7
