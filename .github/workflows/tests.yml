name: Test Suite

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - "**.swift"
      - "**.xcodeproj/**"
      - "**.xcworkspace/**"
      - ".github/workflows/tests.yml"
  pull_request:
    branches: [main]
    paths:
      - "**.swift"
      - "**.xcodeproj/**"
      - "**.xcworkspace/**"
      - ".github/workflows/tests.yml"
  workflow_dispatch:

jobs:
  macos_unit_tests:
    name: macOS Unit Tests
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - macos-version: macos-15
            xcode-path: /Applications/Xcode_16.4.app/Contents/Developer
          - macos-version: macos-26
            xcode-path: /Applications/Xcode_26.0.app/Contents/Developer
    runs-on: ${{ matrix.macos-version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Select Xcode version
        run: sudo xcode-select -s ${{ matrix.xcode-path }}

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Run unit tests
        run: |
          set -o pipefail
          xcodebuild \
            -project Kaset.xcodeproj \
            -scheme Kaset \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            -only-testing:KasetTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            test

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: macOS-TestResults-${{ matrix.macos-version }}
          path: ./build/*.xcresult
          retention-days: 7
