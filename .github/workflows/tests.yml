name: Test Suite

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - "**.swift"
      - "**.xcodeproj/**"
      - "**.xcworkspace/**"
      - ".github/workflows/tests.yml"
  pull_request:
    branches: [main]
    paths:
      - "**.swift"
      - "**.xcodeproj/**"
      - "**.xcworkspace/**"
      - ".github/workflows/tests.yml"
  workflow_dispatch:

jobs:
  macos_unit_tests:
    name: macOS Unit Tests
    timeout-minutes: 20
    runs-on: macos-26
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Run unit tests
        run: |
          set -o pipefail
          xcodebuild \
            -project Kaset.xcodeproj \
            -scheme Kaset \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            -only-testing:KasetTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            test

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: macOS-TestResults
          path: ./build/*.xcresult
          retention-days: 7
