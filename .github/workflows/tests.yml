name: Test Suite

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - "**.swift"
      - "**.xcodeproj/**"
      - "**.xcworkspace/**"
      - ".github/workflows/tests.yml"
  pull_request:
    branches: [main]
    paths:
      - "**.swift"
      - "**.xcodeproj/**"
      - "**.xcworkspace/**"
      - ".github/workflows/tests.yml"
  workflow_dispatch:

jobs:
  macos_unit_tests:
    name: macOS Unit Tests
    timeout-minutes: 20
    runs-on: macos-26
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Run unit tests
        run: |
          set -o pipefail
          xcodebuild \
            -project Kaset.xcodeproj \
            -scheme Kaset \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            -only-testing:KasetTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            test

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: macOS-TestResults
          path: ./build/*.xcresult
          retention-days: 7

  macos_ui_tests:
    name: macOS UI Tests
    timeout-minutes: 30
    runs-on: macos-26
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Run UI tests
        run: |
          set -o pipefail
          xcodebuild \
            -project Kaset.xcodeproj \
            -scheme Kaset \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            -only-testing:KasetUITests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            test

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: macOS-UITestResults
          path: ./build/*.xcresult
          retention-days: 7
