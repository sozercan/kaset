name: Release Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Optional tag/label used for naming the release asset"
        required: false
        default: ""

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: macos-26
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Run unit tests
        run: |
          set -o pipefail
          xcodebuild \
            -project Kaset.xcodeproj \
            -scheme Kaset \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            -only-testing:KasetTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            test

      - name: Determine version from tag
        id: version
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          elif [ -n "${{ github.ref_name }}" ]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="0.0.0"
          fi
          VERSION="${TAG#v}"  # Remove 'v' prefix if present
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Using version: $VERSION"

      - name: Build release configuration
        run: |
          xcodebuild -project Kaset.xcodeproj \
            -scheme Kaset \
            -configuration Release \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            MARKETING_VERSION="${{ steps.version.outputs.version }}" \
            CURRENT_PROJECT_VERSION="${{ github.run_number }}" \
            build

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          APP_PATH=$(find ./build/Build/Products/Release -name "*.app" -type d | head -n 1)

          if [ -z "$APP_PATH" ]; then
            echo "Error: Could not find built app"
            exit 1
          fi

          echo "Found app at: $APP_PATH"

          # Verify app version matches expected version
          PLIST_VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "$APP_PATH/Contents/Info.plist")
          EXPECTED_VERSION="${{ steps.version.outputs.version }}"
          echo "Built app version: $PLIST_VERSION"
          echo "Expected version: $EXPECTED_VERSION"
          if [ "$PLIST_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "Error: Version mismatch!"
            exit 1
          fi

          # Verify Universal Binary (Intel + Apple Silicon)
          ARCHS=$(lipo -archs "$APP_PATH/Contents/MacOS/Kaset" 2>/dev/null || echo "unknown")
          echo "Architectures: $ARCHS"
          if [[ "$ARCHS" != *"x86_64"* ]] || [[ "$ARCHS" != *"arm64"* ]]; then
            echo "Warning: App is not a Universal Binary (found: $ARCHS)"
          fi

          # Create styled DMG with Applications symlink
          create-dmg \
            --volname "Kaset" \
            --window-pos 200 120 \
            --window-size 660 400 \
            --icon-size 100 \
            --icon "Kaset.app" 180 190 \
            --app-drop-link 480 190 \
            --hide-extension "Kaset.app" \
            --no-internet-enable \
            kaset.dmg \
            "$APP_PATH"

      - name: Determine artifact name
        id: artifact
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          elif [ -n "${{ github.ref_name }}" ]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="v${{ steps.version.outputs.version }}"
          fi

          if [ -z "$TAG" ]; then
            TAG="release"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "filename=kaset-$TAG.dmg" >> "$GITHUB_OUTPUT"

      - name: Rename DMG
        run: mv kaset.dmg "${{ steps.artifact.outputs.filename }}"

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ${{ steps.artifact.outputs.filename }}
          path: ${{ steps.artifact.outputs.filename }}
          retention-days: 30

      - name: Calculate SHA256
        id: sha256
        run: |
          SHA256=$(shasum -a 256 "${{ steps.artifact.outputs.filename }}" | awk '{print $1}')
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        id: release_notes
        run: |
          TAG="${{ steps.artifact.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          SHA256="${{ steps.sha256.outputs.sha256 }}"

          # Get previous tag for changelog
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Generate changelog
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" "$PREV_TAG"..HEAD --no-merges | head -50)
          else
            CHANGELOG="- Initial release"
          fi

          # Create release notes
          NOTES=$(cat <<EOF
          ## What's New

          ${CHANGELOG}

          ## Installation

          ### Homebrew (recommended)
          \`\`\`bash
          brew tap sozercan/kaset https://github.com/sozercan/kaset
          brew install --cask kaset --no-quarantine
          \`\`\`

          ### Manual Download
          1. Download \`${{ steps.artifact.outputs.filename }}\`
          2. Open the DMG and drag Kaset to Applications
          3. Remove the quarantine attribute (required for unsigned apps):
             \`\`\`bash
             xattr -d com.apple.quarantine /Applications/Kaset.app
             \`\`\`

          ## Verification

          **SHA256:** \`${SHA256}\`

          Verify with: \`shasum -a 256 ${{ steps.artifact.outputs.filename }}\`
          EOF
          )

          # Write to file (safer than GITHUB_OUTPUT for multiline)
          echo "$NOTES" > release_notes.md

      - name: Check if pre-release
        id: prerelease
        run: |
          TAG="${{ steps.artifact.outputs.tag }}"
          if [[ "$TAG" =~ -(alpha|beta|rc|dev) ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub release and upload DMG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail

          TAG="${{ steps.artifact.outputs.tag }}"
          FILE="${{ steps.artifact.outputs.filename }}"
          TITLE="${TAG}"
          PRERELEASE_FLAG=""

          if [ "${{ steps.prerelease.outputs.is_prerelease }}" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists, uploading asset instead"
            gh release upload "$TAG" "$FILE" --clobber
          else
            gh release create "$TAG" "$FILE" \
              --title "$TITLE" \
              --notes-file release_notes.md \
              $PRERELEASE_FLAG
          fi

      - name: Commit Cask Update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch and checkout the default branch (we're in detached HEAD from tag checkout)
          git fetch origin ${{ github.event.repository.default_branch }}
          git checkout ${{ github.event.repository.default_branch }}

          # Re-apply the cask update on the branch
          TAG="${{ steps.artifact.outputs.tag }}"
          VERSION="${TAG#v}"

          cat > Casks/kaset.rb << EOF
          cask "kaset" do
            version "$VERSION"
            sha256 "${{ steps.sha256.outputs.sha256 }}"

            url "https://github.com/${{ github.repository }}/releases/download/${TAG}/${{ steps.artifact.outputs.filename }}"
            name "Kaset"
            desc "Native macOS YouTube Music client"
            homepage "https://github.com/${{ github.repository }}"

            auto_updates true
            depends_on macos: ">= :tahoe"

            app "Kaset.app"

            zap trash: [
              "~/Library/Application Support/Kaset",
              "~/Library/Caches/com.sertacozercan.Kaset",
              "~/Library/Preferences/com.sertacozercan.Kaset.plist",
              "~/Library/Saved Application State/com.sertacozercan.Kaset.savedState",
              "~/Library/WebKit/com.sertacozercan.Kaset",
            ]
          end
          EOF

          git add Casks/kaset.rb
          git diff --cached --quiet || git commit -m "Update cask to ${{ steps.artifact.outputs.tag }}"
          git push origin ${{ github.event.repository.default_branch }}
