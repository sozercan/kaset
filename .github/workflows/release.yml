name: Release Build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Optional tag/label used for naming the release asset"
        required: false
        default: ""

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: macos-26
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.0.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Run unit tests
        run: |
          set -o pipefail
          xcodebuild \
            -project Kaset.xcodeproj \
            -scheme Kaset \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            -only-testing:KasetTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            test

      - name: Build release configuration
        run: |
          xcodebuild -project Kaset.xcodeproj \
            -scheme Kaset \
            -configuration Release \
            -destination 'platform=macOS' \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Create DMG
        run: |
          APP_PATH=$(find ./build/Build/Products/Release -name "*.app" -type d | head -n 1)

          if [ -z "$APP_PATH" ]; then
            echo "Error: Could not find built app"
            exit 1
          fi

          echo "Found app at: $APP_PATH"

          mkdir -p dmg_contents
          cp -R "$APP_PATH" dmg_contents/

          hdiutil create -volname "Kaset" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            kaset.dmg

      - name: Determine artifact name
        id: artifact
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          elif [ -n "${{ github.ref_name }}" ]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="${GITHUB_SHA::7}"
          fi

          if [ -z "$TAG" ]; then
            TAG="release"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "filename=kaset-$TAG.dmg" >> "$GITHUB_OUTPUT"

      - name: Rename DMG
        run: mv kaset.dmg "${{ steps.artifact.outputs.filename }}"

      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: ${{ steps.artifact.outputs.filename }}
          path: ${{ steps.artifact.outputs.filename }}
          retention-days: 30

      - name: Create GitHub release and upload DMG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail

          TAG="${{ steps.artifact.outputs.tag }}"
          FILE="${{ steps.artifact.outputs.filename }}"
          TITLE="Kaset ${TAG}"
          NOTES="Automated release for ${TAG} (build ${GITHUB_SHA})"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists, uploading asset instead"
            gh release upload "$TAG" "$FILE" --clobber
          else
            gh release create "$TAG" "$FILE" \
              --title "$TITLE" \
              --notes "$NOTES"
          fi
